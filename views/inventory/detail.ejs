<% if (title) { %>
  <h1><%= title %></h1>
<% } else {
  res.locals.title = "Vehicle Detail"
} %>

<%- messages() %>

<%- detail %>

<!-- Reviews Section -->
<div class="reviews-section">
  <div class="reviews-header">
    <h2>Customer Reviews</h2>
    <% if (locals.avg_rating > 0) { %>
      <div class="rating-summary">
        <span class="stars">
          <% for(let i = 1; i <= 5; i++) { %>
            <% if (i <= Math.round(avg_rating)) { %>
              ★
            <% } else { %>
              ☆
            <% } %>
          <% } %>
        </span>
        <span class="rating-text"><%= avg_rating %> out of 5 stars (<%= review_count %> reviews)</span>
      </div>
    <% } %>
  </div>

  <% if (locals.loggedin) { %>
    <div class="add-review-link">
      <a href="/review/add/<%= inv_id %>" class="btn">Write a Review</a>
    </div>
  <% } else { %>
    <p class="login-prompt">
      <a href="/account/login">Log in</a> to write a review
    </p>
  <% } %>

  <div class="reviews-list">
    <% if (reviews && reviews.length > 0) { %>
      <% reviews.forEach(function(review) { %>
        <div class="review-item">
          <div class="review-header">
            <div class="review-author">
              <strong><%= review.account_firstname %> <%= review.account_lastname.charAt(0) %>.</strong>
              <span class="review-date"><%= new Date(review.review_date).toLocaleDateString() %></span>
            </div>
            <div class="review-rating">
              <% for(let i = 1; i <= 5; i++) { %>
                <% if (i <= review.review_rating) { %>
                  ★
                <% } else { %>
                  ☆
                <% } %>
              <% } %>
            </div>
          </div>
          <div class="review-text">
            <p><%= review.review_text %></p>
          </div>
          <% if (locals.loggedin && locals.accountData.account_id === review.account_id) { %>
            <div class="review-actions">
              <a href="/review/edit/<%= review.review_id %>" class="btn-small">Edit</a>
              <a href="/review/delete/<%= review.review_id %>" class="btn-small btn-danger">Delete</a>
            </div>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <p class="no-reviews">No reviews yet. Be the first to review this vehicle!</p>
    <% } %>
  </div>
</div>